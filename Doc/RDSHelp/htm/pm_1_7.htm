<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ru" xml:lang="ru">
<head>
  <link rel="stylesheet" type="text/css" href="../css/main.css" />
  <link rel="stylesheet" type="text/css" href="../css/cpp.css" />
  <meta http-equiv="Content-Type" content="text/html;charset=windows-1251" />
  <script type="text/javascript" src="script.js"></script>
  <title>&sect;1.7. Реакция на действия пользователя</title>
</head><body onload="DocLoad()">
<div class="pageheader"><span class="off"><b>Текущий раздел:</b></span>
<div class="int"><p id="top"><a href="../index.htm">Описания RDS</a></p>
<div class="level"><p><a href="pm_index.htm">Руководство программиста</a></p>
<div class="level"><p><a href="pm_index.htm#light_htm:pm_1">Глава 1. Устройство RDS</a></p>
<div class="level"><p>&sect;1.7. Реакция на действия пользователя</p>
</div>
</div>
</div>
</div></div>
<div class="topnav"><span class="off"><b>Навигация:</b></span>
<div class="left">
<span class="button"><a href="pm_1_6.htm" title="Предыдущий параграф" id="pgup">&lt;&lt;</a></span>
<span class="button"><a href="pm_1_8.htm" title="Следующий параграф" id="pgdn">&gt;&gt;</a></span>
<span class="divider"></span>
<span class="button"><a href="pm_index.htm#light_htm:pm_1_7">Оглавление</a></span>
<span class="button"><a href="alpha.htm">Указатель</a></span>
</div>
</div>

<div class="text">
<h1 class="off">Руководство программиста</h1>
<h2 class="off">Глава 1. Устройство RDS</h2>
<h3>&sect;1.7. Реакция на действия пользователя</h3>
<p class="abstract">Описываются способы реакции модели блока на действия пользователя: нажатие кнопок и перемещение курсора мыши, нажатие и отпускание клавиш клавиатуры. Также описывается создание собственных пунктов меню блока и функции настройки параметров.</p>


<p>Самый простой способ заставить блок реагировать на действия пользователя &ndash; это разрешить данному блоку
реакцию на мышь и клавиатуру (установив флаги в окне параметров блока,
см. <a href="pm_1_4.htm#pic3" title="Параметры блока &ndash; модель и реакции">рис.&nbsp;7</a>)
и добавить в модель
<a href="pm_index.htm#light_htm:pm_2_12" title="&sect;2.12. Реакция блоков на действия пользователя">обработку соответствующих событий</a>. Следует, однако, помнить,
что информация об этих
событиях будет передаваться блоку только в режимах
<a href="pm_1_3.htm#ref2" title="Режим моделирования">моделирования</a>
и <a href="pm_1_3.htm#ref3" title="Режим расчета">расчета</a>, в режиме
<a href="pm_1_3.htm#ref1" title="Режим редактирования">редактирования</a>
часть реакций блока отключается. Кроме того, на мышь и клавиатуру не реагируют блоки, расположенные на
неактивных и невидимых
<a href="um_2_12.htm" title="&sect;2.12.1. Использование слоев">слоях</a>.</p>

<p>Для того, чтобы блок мог реагировать на манипуляции мышью (например, если блоки должны изображать какие-либо
кнопки и переключатели, они должны реагировать на щелчки мыши), необходимо включить в окне параметров блока флаг
&laquo;<span class="menu">блок реагирует на мышь</span>&raquo;.
<span id="ref1">При этом</span>, если курсор мыши будет находиться в пределах
<span id="light_ref1" class="term">описывающего прямоугольника</span> блока
(минимального прямоугольника, полностью покрывающего изображение блока в окне подсистемы), модель будет вызываться
каждый раз при нажатии кнопки мыши, при ее отпускании, а также при перемещении курсора, когда хотя бы одна
кнопка нажата. Чтобы модель блока вызывалась при перемещении курсора даже тогда, когда ни одна кнопка не нажата,
необходимо  включить в окне параметров блока флаг
&laquo;<span class="menu">блок реагирует на движение мыши без нажатия кнопок</span>&raquo;. Это может потребоваться при создании блоков,
изображающих диаграммы и графики &ndash; при перемещении курсора мыши над полем диаграммы можно выводить координаты
точки под курсором.</p>

<p>Все описанные выше события передаются в модель блока только тогда, когда курсор мыши находится в пределах
описывающего прямоугольника блока.
<span id="ref2">При</span> необходимости, модель блока может
<span id="light_ref2" class="term"><a href="pm_2_12_2.htm" title="&sect;2.12.2. Захват мыши, реакция на перемещение курсора">захватить мышь</a></span>,
после чего вся информация о перемещениях курсора и
нажатии кнопок будет поступать только в эту модель, даже если курсор выйдет за пределы блока, до тех пор пока
модель не освободит мышь. Этот механизм может быть полезен, например, при создании модели блока, имитирующего
рукоятку для задания какого-либо значения. При нажатии левой кнопки такая модель может захватить мышь и
использовать информацию о перемещении курсора для изменения положения нарисованной рукоятки, а при отпускании
кнопки &ndash; освобождать мышь и фиксировать получившееся значение. Таким образом, рукоятка, рисуемая блоком,
будет перемещаться, даже если пользователь выведет курсор за пределы изображения блока, до тех пор, пока он
не отпустит кнопку.</p>

<p><span id="ref3">Если</span>
внешний вид блока определяется
<a href="pm_1_4.htm#light_ref4" title="Векторная картинка блока">векторной картинкой</a> и ее элементам присвоены целые идентификаторы, модель при
обработке событий может определить, какой элемент картинки находится под курсором мыши. Для этого используется
сервисная функция <span id="light_ref3"><span class="cpp"><a href="rdsGetPictureObjectId.htm" title="А.5.6.35. rdsGetPictureObjectId &ndash; элемент векторной картинки блока">rdsGetPictureObjectId</a></span></span>, возвращающая
идентификатор элемента картинки, на который приходится точка с заданными координатами. Можно, например, создать
в картинке блока специальные активные зоны и присвоить им разные идентификаторы, а затем, обрабатывая событие
нажатия кнопки мыши, увеличивать или уменьшать значение какой-либо переменной блока в зависимости от зоны, в
которой находится курсор.</p>

<p>Для того, чтобы блок мог реагировать на клавиатуру, необходимо включить в окне параметров блока флаг
&laquo;<span class="menu">блок реагирует на клавиатуру</span>&raquo; и добавить в модель обработку соответствующих событий
(<a href="pm_2_12_4.htm" title="&sect;2.12.4. Реакция блоков на клавиатуру">нажатия и отпускания клавиш</a>). Модель блока будет вызываться только
в том случае, если RDS находится в
режиме моделирования или расчета и окно подсистемы, в которую входит блок, открыто и активно (имеет фокус).
При нажатии и отпускании клавиш по очереди вызываются модели всех блоков активного окна подсистемы, для которых
разрешена реакция на клавиатуру. Вызванная модель может прекратить перебор блоков, проинформировав RDS о том,
что дальнейшая обработка не требуется.</p>

<p>Если ни один из блоков в окне не среагировал на действия пользователя, может быть вызвана модель подсистемы,
которой принадлежит это окно (для этого необходимо разрешить обработку соответствующих событий в окне параметров
подсистемы). Для каждого события, связанного с мышью и клавиатурой, на которое реагируют блоки, существует похожее
событие для подсистемы. Например, при нажатии кнопки мыши модели блоков вызываются с параметром
<span class="cpp"><a href="RDS_BFM_MOUSEDOWN.htm" title="А.2.6.9. RDS_BFM_MOUSEDOWN &ndash; нажатие кнопки мыши">RDS_BFM_MOUSEDOWN</a></span>, а модель подсистемы, которой принадлежит окно, &ndash; с параметром
<span class="cpp"><a href="RDS_BFM_WINDOWMOUSEDOWN.htm" title="А.2.6.17. RDS_BFM_WINDOWMOUSEDOWN &ndash; реакция подсистемы на нажатие кнопки мыши в своем окне">RDS_BFM_WINDOWMOUSEDOWN</a></span>. Подсистема может реагировать на оба этих события: если пользователь
нажмет кнопку мыши на изображении подсистемы в окне ее родителя (где она выглядит как обычный блок,
<a href="#pic1" title="Реакция подсистемы на кнопку мыши на ее изображении (а) и внутри ее окна (б)">рис.&nbsp;12</a>а),
ее модели будет передано событие <span class="cpp">RDS_BFM_MOUSEDOWN</span>, а при нажатии кнопки на свободном
месте ее собственного окна
(<a href="#pic1" title="Реакция подсистемы на кнопку мыши на ее изображении (а) и внутри ее окна (б)">рис.&nbsp;12</a>б) &ndash; событие <span class="cpp">RDS_BFM_WINDOWMOUSEDOWN</span>.</p>

<div class="pic"><div class="container" id="pic1">
<img src="../img/MouseDownEvent.png" width="362" height="207" alt="Реакция подсистемы на кнопку мыши на ее изображении (а) и внутри ее окна (б)" />
<p id="light_pic1">Рис.&nbsp;12. Реакция подсистемы на кнопку мыши на ее изображении (а) и внутри ее окна (б)</p>
</div></div>


<div class="picright"><div class="container" id="pic2">
<img src="../img/SysMenuExtension.png" width="508" height="300" alt="Расширения системного меню" />
<p id="light_pic2">Рис.&nbsp;13. Расширения системного меню</p>
</div></div>


<p><span id="ref4">Все</span>
<span id="ref5">описанные</span>
<span id="ref6">выше</span>
<span id="ref7">реакции</span>
<span id="ref8">работают</span> только в режимах моделирования и расчета.
Для взаимодействия с
пользователем в режиме редактирования модель блока может добавить свои пункты в
<span id="light_ref7">главное</span> (сервисной функцией
<span id="light_ref4"><span class="cpp"><a href="rdsRegisterMenuItem.htm" title="А.5.17.8. rdsRegisterMenuItem &ndash; создать пункт системного меню RDS">rdsRegisterMenuItem</a></span></span>, см.
<a href="pm_2_12_7.htm" title="&sect;2.12.7. Добавление пунктов в системное меню RDS">&sect;2.12.7</a>)  или
<span id="light_ref8">контекстное</span> (сервисными функциями
<span id="light_ref5"><span class="cpp"><a href="rdsRegisterContextMenuItem.htm" title="А.5.17.6. rdsRegisterContextMenuItem &ndash; создать постоянный пункт контекстного меню блока">rdsRegisterContextMenuItem</a></span></span> и
<span id="light_ref6"><span class="cpp"><a href="rdsAdditionalContextMenuItem.htm" title="А.5.17.1. rdsAdditionalContextMenuItem &ndash; добавить временный пункт в контекстное меню блока">rdsAdditionalContextMenuItem</a></span></span>,
см. <a href="pm_2_12_6.htm" title="&sect;2.12.6. Добавление пунктов в контекстное меню блока">&sect;2.12.6</a>) меню RDS. При добавлении пункта меню модель указывает
целый идентификатор, который будет передаваться ей при выборе пользователем этого пункта. Расширения контекстного
меню блока, добавленные моделью, отображаются во всех режимах при щелчке правой кнопкой мыши на изображении блока.
В режиме редактирования они дублируются в подменю &laquo;<span class="menu">Редактирование</span>&raquo; главного меню, если добавивший их
блок выделен. Пункты, добавленные моделями блоков в главное меню, отображаются в подменю
&laquo;<span class="menu">Система | Дополнительно</span>&raquo; и активны независимо от режима или выделенности какого-либо блока
(<a href="#pic2" title="Расширения системного меню">рис.&nbsp;13</a>).
Кроме того, с пунктами главного меню могут быть связаны &laquo;горячие клавиши&raquo;, нажатие которых вызывает
данный пункт меню независимо от того, какое окно в данный момент активно. Таким образом, добавив в главное меню
RDS собственный пункт и задав для него сочетание клавиш, модель блока сможет реагировать на нажатие этих
клавиш в любом режиме, даже если окно с данным блоком не открыто. Обычно в главное меню добавляют свои пункты
уникальные, то есть присутствующие в схеме в единственном экземпляре, блоки.</p>

<p>В режиме редактирования модель блока может также реагировать на вызов пользователем функции настройки,
если он разрешен в окне параметров блока
(см. <a href="pm_1_4.htm#pic3" title="Параметры блока &ndash; модель и реакции">рис.&nbsp;7</a>).
<span id="ref9">Функции</span>
настройки соответствует
пункт контекстного меню или подменю &laquo;<span class="menu">Редактирование</span>&raquo; (название пункта можно изменять), при выборе
которого модель вызывается с параметром
<span id="light_ref9"><span class="cpp"><a href="RDS_BFM_SETUP.htm" title="А.2.6.13. RDS_BFM_SETUP &ndash; вызов функции настройки блока">RDS_BFM_SETUP</a></span></span>. В ответ на этот вызов модель
должна самостоятельно организовать диалог с
пользователем средствами Windows или при помощи сервисных функций, описанных в
<a href="pm_2_7_2.htm" title="&sect;2.7.2. Использование объектов-окон RDS">&sect;2.7.2</a>.</p>

</div>
<p style="clear:both; min-height:1em; padding:0px; margin: 0px;"></p><hr class="off" /><div class="bottomnav">
<div class="left">
<span class="button"><a href="pm_1_6.htm" title="Предыдущий параграф" id="pgup_f">&lt;&lt;</a></span>
<span class="button"><a href="pm_1_8.htm" title="Следующий параграф" id="pgdn_f">&gt;&gt;</a></span>
<span class="divider"></span>
<span class="button"><a href="pm_index.htm#light_htm:pm_1_7">Оглавление</a></span>
<span class="button"><a href="alpha.htm">Указатель</a></span>
</div>
</div>
</body>
</html>
